<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Temp Folder Gallery</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f8fb; padding:20px; }
    .gallery-header { background: linear-gradient(90deg,#4285f4,#34a853); color:white; padding:18px; border-radius:8px; }
    .card-thumb { height:180px; object-fit:cover; width:100%; }
    .folder-card { cursor:pointer; }
    .list-view-img { width:100px; height:70px; object-fit:cover; }
    .loading { text-align:center; padding:40px; display:none; }
    .empty { text-align:center; padding:30px; color:#6c757d; display:none; }
    .delete-btn { position:absolute; top:8px; right:8px; }
    .card { position:relative; }
  </style>
</head>
<body>
  <div class="container">
    <div class="gallery-header mb-4">
      <h3 class="mb-0">ðŸ“‚ Temp Folder Gallery</h3>
      <small>Browse & manage files in your Drive's temp folder</small>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="input-group w-50">
        <input id="searchInput" class="form-control form-control-sm" placeholder="Search image name...">
        <button id="clearSearch" class="btn btn-light btn-sm">Clear</button>
      </div>

      <div>
        <div class="btn-group">
          <button id="gridBtn" class="btn btn-sm btn-primary">Grid</button>
          <button id="listBtn" class="btn btn-sm btn-outline-primary">List</button>
        </div>
        <button id="refreshBtn" class="btn btn-sm btn-secondary ms-2">Refresh</button>
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Loading...</p>
    </div>

    <div id="empty" class="empty">No files found.</div>

    <div id="grid" class="row g-3"></div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="modalTitle" class="modal-title">Preview</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img id="modalImage" class="img-fluid" alt="preview" style="max-height:70vh;">
            <p class="mt-2 text-muted" id="modalDate"></p>
          </div>
          <div class="modal-footer">
            <a id="openDriveBtn" class="btn btn-primary" target="_blank" rel="noopener">Open in Drive</a>
            <button id="deleteBtnModal" class="btn btn-danger">Delete</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /************ CONFIG ************/
    const WEBHOOK_BASE = "https://n8n-v2.sigmagrowthpartners.com/webhook/6b37fe2a-9d47-4c55-9d71-ba4c95736fbc";
    const INITIAL_FOLDER_ID = "1fgmaYdKQbRw7A73-fbcdPjl8oLvvRjAK"; // replace with your real temp folder id
    /********************************/

    let currentView = 'grid';
    let allItems = [];
    let selectedItem = null;

    const gridEl = document.getElementById('grid');
    const loadingEl = document.getElementById('loading');
    const emptyEl = document.getElementById('empty');
    const searchInput = document.getElementById('searchInput');
    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalTitle');
    const modalDate = document.getElementById('modalDate');
    const openDriveBtn = document.getElementById('openDriveBtn');
    const deleteBtnModal = document.getElementById('deleteBtnModal');

    document.getElementById('gridBtn').addEventListener('click', () => { currentView='grid'; render(); });
    document.getElementById('listBtn').addEventListener('click', () => { currentView='list'; render(); });
    document.getElementById('refreshBtn').addEventListener('click', () => fetchAndRender());
    document.getElementById('clearSearch').addEventListener('click', () => { searchInput.value=''; render(); });
    searchInput.addEventListener('input', () => render());

    deleteBtnModal.addEventListener('click', () => {
      if (selectedItem) deleteItem(selectedItem);
    });

    function showLoading(){ loadingEl.style.display='block'; gridEl.style.display='none'; emptyEl.style.display='none'; }
    function hideLoading(){ loadingEl.style.display='none'; gridEl.style.display='flex'; }

    async function fetchFolder() {
      const url = `${WEBHOOK_BASE}/list-images/${encodeURIComponent(INITIAL_FOLDER_ID)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Fetch error " + res.status);
      return res.json();
    }

    function mapItem(item){
      const isFolder = item.mimeType === 'application/vnd.google-apps.folder';
      return {
        id: item.id,
        name: item.name,
        isFolder,
        thumbnailUrl: item.thumbnailLink || `https://drive.google.com/uc?id=${item.id}`,
        fullUrl: item.webViewLink || item.webContentLink || `https://drive.google.com/uc?id=${item.id}&export=download`,
        modifiedTime: item.modifiedTime || null,
        raw: item
      };
    }

    async function fetchAndRender() {
      showLoading();
      try {
        const data = await fetchFolder();
        allItems = data.map(mapItem).filter(i => !i.isFolder); // only files in temp
        render();
      } catch(err) {
        console.error(err);
        gridEl.innerHTML='';
        emptyEl.style.display='block';
        emptyEl.textContent='Error fetching files. Check console.';
      } finally {
        hideLoading();
      }
    }

    function render() {
      const q = searchInput.value.toLowerCase();
      const images = allItems.filter(i => !q || i.name.toLowerCase().includes(q));
      gridEl.innerHTML='';

      if (images.length===0){ emptyEl.style.display='block'; return; }
      else emptyEl.style.display='none';

      images.forEach(img=>{
        const col=document.createElement('div');
        col.className=currentView==='grid' ? 'col-sm-6 col-md-4 col-lg-3' : 'col-12';
        const card=document.createElement('div');
        card.className='card';

        if (currentView==='grid'){
          card.innerHTML=`
            <button class="btn btn-sm btn-danger delete-btn">ðŸ—‘</button>
            <img src="${img.thumbnailUrl}" class="card-img-top card-thumb" alt="${img.name}">
            <div class="card-body">
              <h6 class="card-title mb-1">${img.name}</h6>
              <p class="text-muted" style="font-size:0.8rem;">${img.modifiedTime ? new Date(img.modifiedTime).toLocaleString() : ''}</p>
            </div>`;
          card.querySelector('img').addEventListener('click', ()=>openPreview(img));
          card.querySelector('.card-body').addEventListener('click', ()=>openPreview(img));
          card.querySelector('.delete-btn').addEventListener('click', (e)=>{ e.stopPropagation(); deleteItem(img); });
        } else {
          card.innerHTML=`
            <div class="d-flex p-2 align-items-center">
              <img src="${img.thumbnailUrl}" class="list-view-img me-3" alt="${img.name}">
              <div class="flex-grow-1">
                <h6 class="mb-0">${img.name}</h6>
                <small class="text-muted">${img.modifiedTime ? new Date(img.modifiedTime).toLocaleString() : ''}</small>
              </div>
              <button class="btn btn-sm btn-outline-primary me-2">View</button>
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </div>`;
          card.querySelector('.btn-outline-primary').addEventListener('click', ()=>openPreview(img));
          card.querySelector('.btn-outline-danger').addEventListener('click', ()=>deleteItem(img));
        }
        col.appendChild(card);
        gridEl.appendChild(col);
      });
    }

    function openPreview(img){
      selectedItem=img;
      modalImage.src=img.fullUrl;
      modalTitle.textContent=img.name;
      modalDate.textContent=img.modifiedTime ? new Date(img.modifiedTime).toLocaleString() : '';
      openDriveBtn.href=img.fullUrl;
      imageModal.show();
    }

    async function deleteItem(img){
      if(!confirm(`Delete "${img.name}" permanently?`)) return;
      try {
        const url = `${WEBHOOK_BASE}/delete-file/${encodeURIComponent(img.id)}`;
        const res = await fetch(url, { method: 'DELETE' });
        if(!res.ok) throw new Error("Delete failed " + res.status);
        allItems = allItems.filter(i=>i.id!==img.id);
        render();
        imageModal.hide();
        alert("File deleted");
      } catch(err) {
        console.error(err);
        alert("Delete error. Check console.");
      }
    }

    fetchAndRender();
  </script>
</body>
</html>