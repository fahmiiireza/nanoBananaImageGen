<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Drive Gallery</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f8fb; padding:20px; }
    .gallery-header { background: linear-gradient(90deg,#4285f4,#34a853); color:white; padding:18px; border-radius:8px; }
    .card-thumb { height:180px; object-fit:cover; width:100%; }
    .folder-card { cursor:pointer; }
    .list-view-img { width:100px; height:70px; object-fit:cover; }
    .loading { text-align:center; padding:40px; display:none; }
    .empty { text-align:center; padding:30px; color:#6c757d; display:none; }
    .delete-btn { position:absolute; top:8px; right:8px; }
    .card { position:relative; }
    .folder-icon { font-size: 5rem; text-align: center; }
  </style>
  <style>
  .submit-btn {
    display: none; /* Initially hidden */
    background-color: #007bff;
    color: white;
    padding: 14px 28px;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
    transition: all 0.3s ease;
  }

  .submit-btn:hover {
    background-color: #0056b3;
    transform: scale(1.05);
    box-shadow: 0 6px 14px rgba(0, 123, 255, 0.5);
  }

  .submit-btn:active {
    transform: scale(0.98);
  }

  /* ✅ Make button responsive */
  @media (max-width: 576px) {
    .submit-btn {
      font-size: 16px;
      padding: 12px 22px;
      width: 100%;
    }
  }
</style>

</head>
<body>
  <div class="container">
    <div class="gallery-header mb-4">
      <h3 class="mb-0">📂 Google Drive Gallery</h3>
      <small>Browse & manage files in your Drive folder</small>
    </div>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb" id="breadcrumb"></ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="input-group w-50">
        <input id="searchInput" class="form-control form-control-sm" placeholder="Search image name...">
        <button id="clearSearch" class="btn btn-light btn-sm">Clear</button>
      </div>
       <div>
          <div class="btn-group">
             <button id="backBtn" class="btn btn-sm btn-secondary ms-2">Back</button>
             <button id="refreshBtn" class="btn btn-sm btn-secondary ms-2">Refresh</button>
          </div>
          <div class="btn-group">
             <button id="gridBtn" class="btn btn-sm btn-primary">Grid</button>
             <button id="listBtn" class="btn btn-sm btn-outline-primary">List</button>
          </div>
         <div class="text-center mt-3">
         <button id="submitBtn" class="submit-btn">Submit</button>
         </div>

       </div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Loading...</p>
    </div>

    <div id="empty" class="empty">No files found.</div>
    <div id="submit-success-message" class="alert alert-success" style="display: none;" role="alert"></div>

    <div id="grid" class="row g-3"></div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="modalTitle" class="modal-title">Preview</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img id="modalImage" class="img-fluid" alt="preview" style="max-height:70vh;">
            <p class="mt-2 text-muted" id="modalDate"></p>
          </div>
          <div class="modal-footer">
            <a id="openDriveBtn" class="btn btn-primary" target="_blank" rel="noopener">Open in Drive</a>
            <button id="renameBtnModal" class="btn btn-warning">Rename</button>
            <button id="deleteBtnModal" class="btn btn-danger">Delete</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal fade" id="renameModal" tabindex="-1">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Rename File</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" id="renameInput" class="form-control" placeholder="Enter new name">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="renameSaveBtn" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentView = 'grid';
    let allItems = [];
    let selectedItem = null;
    let historyStack = [];

    const gridEl = document.getElementById('grid');
    const loadingEl = document.getElementById('loading');
    const emptyEl = document.getElementById('empty');
    const searchInput = document.getElementById('searchInput');
    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalTitle');
    const modalDate = document.getElementById('modalDate');
    const openDriveBtn = document.getElementById('openDriveBtn');
    const deleteBtnModal = document.getElementById('deleteBtnModal');
    const breadcrumbEl = document.getElementById('breadcrumb');
    const submitBtn = document.getElementById('submitBtn');
    const submitSuccessMessage = document.getElementById('submit-success-message');

    // Rename modal references
    const renameBtnModal = document.getElementById('renameBtnModal');
    const renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
    const renameInput = document.getElementById('renameInput');
    const renameSaveBtn = document.getElementById('renameSaveBtn');

    document.getElementById('gridBtn').addEventListener('click', () => { currentView='grid'; render(); });
    document.getElementById('listBtn').addEventListener('click', () => { currentView='list'; render(); });
    document.getElementById('refreshBtn').addEventListener('click', () => fetchAndRender(historyStack[historyStack.length - 1].id));
    document.getElementById('clearSearch').addEventListener('click', () => { searchInput.value=''; render(); });
    document.getElementById('backBtn').addEventListener('click', () => goBack());
    searchInput.addEventListener('input', () => render());

    deleteBtnModal.addEventListener('click', () => {
      if (selectedItem) deleteItem(selectedItem);
    });

    // Open rename modal from preview
    renameBtnModal.addEventListener('click', () => {
      if (selectedItem) {
        renameInput.value = selectedItem.name;
        renameModal.show();
      }
    });

    // Save rename
    renameSaveBtn.addEventListener('click', async () => {
      if (!selectedItem) return;
      const newName = renameInput.value.trim();
      if (!newName) {
        alert("Please enter a valid name.");
        return;
      }
      try {
        const res = await fetch(`/api/gdrive/files/${selectedItem.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName })
        });
        if (!res.ok) throw new Error("Rename failed");
        selectedItem.name = newName;
        render(); // refresh UI
        renameModal.hide();
        modalTitle.textContent = newName; // update preview modal title
        alert(`Renamed to "${newName}"`);
      } catch (err) {
        console.error(err);
        alert("Error renaming file");
      }
    });

    submitBtn.addEventListener('click', async () => {
      const currentFolder = historyStack[historyStack.length - 1];
      if (currentFolder && historyStack.length > 1) {
        const folderId = currentFolder.id;
        const currentFolderName = currentFolder.name;

        // 1. Get the file count
        const imageCount = allItems.filter(item => item.mimeType.startsWith('image/')).length;
        const fileIds = allItems.filter(item => item.mimeType.startsWith('image/')).map(item => item.id);

        // 2. Get the current date
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const year = today.getFullYear();
        const dateString = `${month}${day}${year}`;

        // 3. Construct the new folder name
        const nameParts = currentFolderName.split(' - ');
        const imageIndex = nameParts.findIndex(part => part.toLowerCase() === 'image');
        const baseName = imageIndex > -1 ? nameParts.slice(0, imageIndex).join(' - ') : currentFolderName;
        const newFolderName = `${baseName} - Image - ${dateString} - (${imageCount})`;

        console.log('Generated Folder Name:', newFolderName);

        try {
          // 4. Rename the folder
          const renameRes = await fetch(`/api/gdrive/files/${folderId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newFolderName })
          });

          if (!renameRes.ok) {
            const errorResponse = await renameRes.json();
            throw new Error(errorResponse.error || 'Folder rename failed');
          }

          // Update the UI with the new name
          currentFolder.name = newFolderName;
          renderBreadcrumb();

          // 5. Call the webhook with the new folder name
          const verticalName = newFolderName.split(' - ')[1]?.trim();
          const webhookResponse = await fetch('https://n8n-v2.sigmagrowthpartners.com/webhook/move-folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ folderName: newFolderName, folderId, verticalName, fileIds }),
          });

          if (!webhookResponse.ok) {
            throw new Error(`Webhook failed with status: ${webhookResponse.status}`);
          }

          const webhookData = await webhookResponse.json();
          submitSuccessMessage.innerHTML = `Folder '${newFolderName}' renamed and moved successfully! You can view it <a href="${webhookData.linkToFolder}" target="_blank" rel="noopener noreferrer">here</a>.`
          submitSuccessMessage.className = 'alert alert-success';
          submitSuccessMessage.style.display = 'block';

        } catch (error) {
          console.error('Error in submit process:', error);
          submitSuccessMessage.className = 'alert alert-danger';
          submitSuccessMessage.innerHTML = `Error: ${error.message}`;
          submitSuccessMessage.style.display = 'block';
        }
      }
    });

    function showLoading(){ loadingEl.style.display='block'; gridEl.style.display='none'; emptyEl.style.display='none'; }
    function hideLoading(){ loadingEl.style.display='none'; gridEl.style.display='flex'; }

    async function fetchFiles(folderId) {
      const url = folderId ? `/api/gdrive/files?folderId=${folderId}` : '/api/gdrive/files';
      const res = await fetch(url);
      if (!res.ok) throw new Error("Fetch error " + res.status);
      return res.json();
    }

    async function fetchPrompt(fileId) {
      const res = await fetch(`/api/gdrive/prompt/${fileId}`);
      if (!res.ok) throw new Error("Fetch prompt error " + res.status);
      return res.json();
    }

    function mapItem(item){
      return {
        id: item.id,
        name: item.name,
        mimeType: item.mimeType,
        thumbnailUrl: item.thumbnailLink,
        fullUrl: item.webViewLink,
        embedLink: `https://drive.google.com/uc?export=view&id=${item.id}`,
        imageProxyLink: `/api/gdrive/image/${item.id}`,
        modifiedTime: item.modifiedTime || null,
        raw: item
      };
    }

    async function fetchAndRender(folderId, folderName = 'Home') {
      showLoading();
      try {
        const data = await fetchFiles(folderId);
        allItems = data.map(mapItem);
        if (!folderId) {
          historyStack = [{id: null, name: 'Home'}];
        } else if (historyStack[historyStack.length - 1].id !== folderId) {
          historyStack.push({id: folderId, name: folderName});
        }
        render();
        renderBreadcrumb();
      } catch(err) {
        console.error(err);
        gridEl.innerHTML='';
        emptyEl.style.display='block';
        emptyEl.textContent='Error fetching files. Check console.';
      } finally {
        hideLoading();
      }
    }

    function render() {
      const q = searchInput.value.toLowerCase();
      const items = allItems.filter(i => !q || i.name.toLowerCase().includes(q));
      const promptFile = allItems.find(i => i.name.toLowerCase() === 'prompt.json');
      gridEl.innerHTML='';

      if (promptFile) {
        fetchPrompt(promptFile.id).then(data => {
          if (data) {
            const promptDiv = document.createElement('div');
            promptDiv.className = 'alert alert-info w-100';
            promptDiv.innerHTML = `<strong>Prompt:</strong> ${data.imageDescription}`;
            gridEl.insertBefore(promptDiv, gridEl.firstChild);
          }
        }).catch(err => {
          console.error("Error fetching prompt:", err);
        });
      }

      if (items.length===0){ emptyEl.style.display='block'; return; }
      else emptyEl.style.display='none';

      items.forEach(item=>{
        const col=document.createElement('div');
        col.className=currentView==='grid' ? 'col-sm-6 col-md-4 col-lg-3' : 'col-12';
        const card=document.createElement('div');
        card.className='card';

        if (item.mimeType === 'application/vnd.google-apps.folder') {
          card.classList.add('folder-card');
          card.innerHTML=`
             <button class="btn btn-sm btn-danger delete-btn" style="position:absolute; top:5px; right:5px;">🗑</button>
    <div class="card-body text-center folder-body" style="cursor:pointer;">
      <div class="folder-icon" style="font-size:40px;">📁</div>
      <h6 class="card-title mb-1">${item.name}</h6>
    </div>
  `;
            // Clicking folder name opens folder
  card.querySelector('.folder-body').addEventListener('click', () => openFolder(item.id, item.name));

  // Clicking trash deletes folder
  card.querySelector('.delete-btn').addEventListener('click', (e) => {
    e.stopPropagation(); // Prevent folder from opening
    deleteItem(item);
  });
        } else if (item.mimeType.startsWith('image/')) {
          if (currentView==='grid'){
            card.innerHTML=`
              <button class="btn btn-sm btn-danger delete-btn">🗑</button>
              <img src="${item.imageProxyLink}" class="card-img-top card-thumb" alt="${item.name}">
              <div class="card-body">
                <h6 class="card-title mb-1">${item.name}</h6>
                <p class="text-muted" style="font-size:0.8rem;">${item.modifiedTime ? new Date(item.modifiedTime).toLocaleString() : ''}</p>
              </div>`;
            card.querySelector('img').addEventListener('click', ()=>openPreview(item));
            card.querySelector('.card-body').addEventListener('click', ()=>openPreview(item));
            card.querySelector('.delete-btn').addEventListener('click', (e)=>{ e.stopPropagation(); deleteItem(item); });
          } else {
            card.innerHTML=`
              <div class="d-flex p-2 align-items-center">
                <img src="${item.imageProxyLink}" class="list-view-img me-3" alt="${item.name}">
                <div class="flex-grow-1">
                  <h6 class="mb-0">${item.name}</h6>
                  <small class="text-muted">${item.modifiedTime ? new Date(item.modifiedTime).toLocaleString() : ''}</small>
                </div>
                <button class="btn btn-sm btn-outline-primary me-2">View</button>
                <button class="btn btn-sm btn-outline-danger">Delete</button>
              </div>`;
            card.querySelector('.btn-outline-primary').addEventListener('click', ()=>openPreview(item));
            card.querySelector('.btn-outline-danger').addEventListener('click', ()=>deleteItem(item));
          }
        }
        col.appendChild(card);
        gridEl.appendChild(col);
      });
    }

    function openFolder(folderId, folderName) {
      fetchAndRender(folderId, folderName);
    }

    function goBack() {
      if (historyStack.length > 1) {
        historyStack.pop();
        const previousFolder = historyStack[historyStack.length - 1];
        fetchAndRender(previousFolder.id, previousFolder.name);
      }
    }

    function renderBreadcrumb() {
      breadcrumbEl.innerHTML = '';
      historyStack.forEach((folder, index) => {
        const li = document.createElement('li');
        li.className = `breadcrumb-item ${index === historyStack.length - 1 ? 'active' : ''}`;
        if (index < historyStack.length - 1) {
          const a = document.createElement('a');
          a.href = '#';
          a.textContent = folder.name;
          a.addEventListener('click', (e) => {
            e.preventDefault();
            historyStack = historyStack.slice(0, index + 1);
            fetchAndRender(folder.id, folder.name);
          });
          li.appendChild(a);
        } else {
          li.textContent = folder.name;
        }
        breadcrumbEl.appendChild(li);
      });

      if (historyStack.length > 1) {
        submitBtn.style.display = 'block';
      } else {
        submitBtn.style.display = 'none';
      }
    }

    function openPreview(img){
      selectedItem=img;
      modalImage.src = img.imageProxyLink;
      modalTitle.textContent=img.name;
      modalDate.textContent=img.modifiedTime ? new Date(img.modifiedTime).toLocaleString() : '';
      openDriveBtn.href=img.fullUrl;
      imageModal.show();
    }

    async function deleteItem(img){
      if(!confirm(`Delete "${img.name}" permanently?`)) return;
      try {
        const isFolder = img.mimeType === "application/vnd.google-apps.folder";
        const res = await fetch(`/api/gdrive/${isFolder ? 'folders' : 'files'}/${img.id}`, { method: 'DELETE' });

        if(!res.ok) throw new Error("Delete failed " + res.status);
        allItems = allItems.filter(i=>i.id!==img.id);
        render();
        imageModal.hide();
        alert("File deleted");
      } catch(err) {
        console.error(err);
        alert("Delete error. Check console.");
      }
    }

    fetchAndRender();
  </script>
</body>
</html>
